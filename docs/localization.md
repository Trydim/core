
- в папке lang хранятся переводы только админки, без возможности редактировать.
- переводы конфигураторов в другом месте (подумать)
- можно ли затереть переводы админки через какие-то внешние файлы (подумать)

- файлы перевод lang/ru/**.php содержат (должны) полный перевод всего.
- дублируемые ключи и переводы для английского удалены.
- файлы с переводами добавлять в shared/lang. расширение csv.

# Мультиязычность в CMS: инструкция
## Что нужно для работы мультиязычности
### 1. Настройка конфигурации
   В файле config.php нужно добавить настройки языков:

```php
'LOCALES' => [
  'BASE_LANG' => 'ru', // базовый язык системы
  'TARGET_LANG' => 'ru', // текущий язык по умолчанию (может быть en, pl и др.)
  'ALL_LANGUAGES' => [ // все доступные языки
    ['name' => 'Русский', 'code' => 'ru'],
    ['name' => 'English', 'code' => 'en']
  ],
  'CSV_FILES' => [ // файлы с переводами
  'locales/common_phrases.csv',
  'locales/user_fields.csv',
  ]
]
```

#### Поведение при отсутствии конфигурации ###
1. Базовый язык:
     Если не указан `BASE_LANG` в конфигурации, 
     система использует значение по умолчанию `'ru'` из константы `Main::$BASE_LANG`

2. Целевой язык:
     
При отсутствии `TARGET_LANG` система будет использовать:

- Язык из куки `target_lang` (если установлен)

- Базовый язык (`BASE_LANG` или `'ru'` по умолчанию)

3. Доступные языки:

Если не указан `ALL_LANGUAGES`:
- система будет считать доступным только базовый язык:
- Переключатель языков в шапке сайта не отобразится

4. Переводы:

- Система будет работать только с базовым языком
- Не будет пытаться загружать словари для других языков
 
***Как добавить языки у Дилера?***

1. Через настройки дилера:
 - Структура таблицы `prop_available_languages`
  ```SQL
    CREATE TABLE `prop_available_languages` (
          `ID` int(10) UNSIGNED NOT NULL,
          `name` varchar(255) NOT NULL DEFAULT 'NoName',
          `code` varchar(255) DEFAULT NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
  ```
     
 - Языки дилера настраиваются в его настройках через параметр `prop_available_languages`
     ```SQL
     INSERT INTO prop_available_languages (ID, name, code) VALUES (NULL, 'Русский', 'ru'), (NULL, 'English', 'en');
     ```
2. Особенности работы:
- Если у дилера не указаны доступные языки в настройках:

  - Система использует язык из основного конфига (`TARGET_LANG`)
  - Переключатель языков не отображается

- Приоритет языков дилера выше, чем в основном конфиге
- Если выбранный язык не входит в список доступных у дилера, система автоматически переключит на первый доступный язык

Где хранятся словари дилера:

3. Основные словари ищутся по пути:
   - `[директория_дилера]/lang/` - для базового языка
   - `[директория_дилера]/lang/[язык]/` - для других языков `en`, `pl`, `...`
   
   Форматы файлов такие же, как в основной системе:

   `dictionary.php` - общие фразы

   `dbDictionary.php` - переводы для БД

### 2. Структура файлов переводов

В корне сайта должна быть папка /lang/ с подкаталогами для дополнительного языка:
```
/lang/
  # Для русского языка
  dictionary.php   # Основной словарь переводов
  dbDictionary.php # Переводы для БД (например, названия статусов)

  /en/               # Для английского языка
    dictionary.php
    dbDictionary.php
```

### 3. Как работает определение языка
   При инициализации сайта CMS определяет целевой язык следующим образом:

   - Если передан параметр lang в URL (например, ?lang=en):

   - Устанавливается кука target_lang на 10 лет

   - Происходит редирект без `lang` в URL

   - Если нет параметра, язык берётся из cookie

   - Если нет cookie — используется `TARGET_LANG` из конфига

   - Если открывается заказ (в админке или на фронте), то язык заказа имеет приоритет (берётся из поля `importantValue.targetLang`)
    

### 4. Переключение языка на фронтенде (core/views/parts/header.php)
  ```php
  $availableLanguages = $main->getAvailableLanguages();
  $currentLang = $main->getTargetLang();

  echo "<input type='hidden' id='targetLang' value='$currentLang'>";
  ```
### 5. Как получить язык на фронтенде (JS)
   Для JavaScript язык доступен через скрытое поле:
   
   ```js
    const getTargetLang = (dataSelector = '#targetLang') => {
      let node = document.querySelector(dataSelector);
      const targetLang = node ? node.value : null;
      node && node.remove();
      
      return targetLang;
    };

    window.targetLang = getTargetLang();
   ```

### 6. Инициализация словарей для JS
- В PHP:
   ```php
   $field['footerContent'] .= $main->initDictionary();
   ```

- Это создаёт скрытое поле:
  ```html
  <input type='hidden' id='dictionaryData' value='{"order_saved":"Заказ сохранен", ...}'>  
  ```
  В JavaScript доступна глобальная функция `_('key param1=%1 param2=%1 ...', 'param1', 'param2', ...)` для получения переводов по ключу с плейсходерами, 
  в калькуляторе ее нужно дополнить дополнительными словарями


### 7. Принудительная установка языка в PHP
Это нужно для отображения заказа и правильной генерации PDF, Excel и прочих шаблонов .
```php
$main->setTargetLang('en');
```
Метод должен вызываться до инициализации словарей

### 8. Сохранение языка в заказе
- При сохранении заказа на фронте:
 
  ```js
    data.set('mode', 'DB');
    data.set('dbAction', 'saveOrder');
  
    if (window.targetLang) {
      iReport.targetLang = window.targetLang; // Язык сохраняется в importantValue.targetLang
    }
  
    data.set('importantValue', JSON.stringify(iReport));
  ```
- В PHP заказе это поле будет доступно как:

```php
$order['importantValue']['targetLang'];
```

### 9. Особенности работы
- Язык сохраняется в cookie на 10 лет
- При смене языка — редирект без лишних ?lang=xx в URL
- При открытии заказа — язык заказа всегда имеет приоритет (даже если кука другая),
- Словари можно дополнять CSV-файлами, указанными в конфиге. Их можно реадктировать в админке.
- Для дилеров может быть своя настройка доступных языков (в свойстве ```available_languages```)
